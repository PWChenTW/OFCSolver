# Claude Code 通用專案配置

## 核心開發原則

### 漸進式開發 (Progressive Development)
- **Start Small**: 從最簡單的可運行版本開始
- **Iterate Fast**: 快速迭代，每次只增加一個小功能
- **Fail Early**: 儘早發現問題，避免累積技術債
- **MVP First**: 先做出最小可行產品，再逐步優化

### 批判性思考 (Critical Thinking)
- **質疑需求**: 主動評估用戶需求的合理性和優先級
- **挑戰假設**: 不盲目接受，要驗證假設是否成立
- **提供替代方案**: 當發現更好的解決方案時，主動提出
- **誠實反饋**: 如果某個想法有問題，直接指出並解釋原因

### 實用主義 (Pragmatism)
- **避免過度設計**: 不要一開始就建立複雜架構
- **YAGNI原則**: You Aren't Gonna Need It - 只實現當前需要的功能
- **簡單優先**: 能用簡單方案解決的，不用複雜方案
- **可用性優先**: 先確保基本功能正常運作，再考慮優化

詳見 `docs/guides/mvp-development.md` 了解 MVP 開發最佳實踐。

## 項目概述
這是一個集成了多實例協作、規格驅動開發(SDD)、和專業Sub Agents的通用AI協作開發模板。

## AI 助手指導原則

### 任務委派基本原則
- **複雜或專業任務**：必須委派給適當的 Sub Agents
- **簡單查詢**：可直接處理以提高效率
- **有疑慮時**：優先選擇委派以確保品質

### 通用助手
對於不符合特定專業代理的查詢，使用：
- `general-assistant`：一般問答、簡單任務、跨領域協調

### 🚨 強制委派規則（必須遵守）

以下情況**必須**委派給指定的 Sub Agent，**禁止**直接實作：

#### 1. 架構與設計相關
- **修改領域模型（Entity, Value Object, Aggregate）** → `architect`
- **修改系統架構或模組結構** → `architect`  
- **設計新的設計模式或架構模式** → `architect`
- **技術選型或框架選擇** → `architect`
- **創建新的應用服務（超過 50 行程式碼）** → `architect` + `tech-lead`

#### 2. 業務邏輯與需求
- **需求不明確或需要澄清** → `business-analyst`
- **需要生成 BDD 場景** → `business-analyst`
- **用戶故事或功能規劃** → `business-analyst`
- **業務規則變更** → `business-analyst`
- **用戶體驗和介面設計** → `business-analyst`
- **工作流程設計和優化** → `business-analyst`

#### 3. 數據與算法
- **修改計算邏輯（如評分、排名）** → `data-specialist`
- **實作新演算法** → `data-specialist`
- **性能優化相關** → `data-specialist`
- **數據結構設計或修改** → `data-specialist`
- **錯誤恢復策略和重試機制** → `data-specialist`
- **監控指標和性能分析** → `data-specialist`

#### 4. 測試與驗證
- **修改驗證規則** → `test-engineer`
- **設計測試策略** → `test-engineer`
- **實作測試案例** → `test-engineer`
- **程式碼品質檢查** → `test-engineer`
- **整合測試規劃** → `test-engineer`
- **錯誤場景測試** → `test-engineer`

#### 5. 技術決策與品質
- **重大技術決策** → `tech-lead`
- **程式碼審查需求** → `tech-lead`
- **技術債務評估** → `tech-lead`
- **最佳實踐制定** → `tech-lead`
- **多服務協調設計** → `tech-lead`
- **系統整合策略** → `tech-lead`

#### 6. 外部整合
- **API 設計和對接** → `integration-specialist`
- **第三方服務整合** → `integration-specialist`
- **微服務間通訊** → `integration-specialist`

#### 7. 文檔與知識管理
- **重要決策文檔化** → `context-manager`
- **技術規範更新** → `context-manager`
- **知識庫維護** → `context-manager`

### ⚡ 快速實作陷阱警告

**常見錯誤模式**：
1. ❌ 看到需求就立即開始寫程式碼
2. ❌ 認為「這很簡單，我直接做就好」
3. ❌ 想要展示快速解決問題的能力
4. ❌ 只調用一個 agent 就開始實作
5. ❌ 跳過複雜度評估直接判斷「不複雜」
6. ❌ 認為「已有類似實作」所以不需要委派

**正確做法**：
1. ✅ **強制執行複雜度評估檢查清單**
2. ✅ 符合強制委派規則的立即委派
3. ✅ 執行多階段委派流程
4. ✅ 等待 Sub Agent 分析後再實作
5. ✅ 基於專業分析結果進行開發
6. ✅ 實作完成後進行自我反思

### 🪞 自我反思機制（任務完成後必須執行）

**每個任務完成後，必須問自己**：

#### 委派決策反思
1. 🤔 我是否正確評估了任務複雜度？
2. 🤔 我是否委派了所有應該委派的部分？
3. 🤔 哪些 Sub Agent 應該參與但沒有參與？
4. 🤔 如果重新來過，我會如何改進委派策略？

#### 實作品質反思
5. 🤔 最終實作是否真的符合 MVP 原則？
6. 🤔 是否存在過度設計的部分？
7. 🤔 是否有遺漏的錯誤處理或測試？
8. 🤔 程式碼是否易於維護和擴展？

#### 協作效果反思
9. 🤔 Sub Agent 的建議是否被正確採納？
10. 🤔 是否存在 Agent 間的建議衝突？
11. 🤔 整個流程是否高效且高品質？
12. 🤔 用戶的真實需求是否被滿足？

### 📚 實際案例學習

#### 案例 1：TASK-014 分析（反面教材）

**任務**：實作 Analysis Orchestrator（監控儀表板 + 工作流程協調 + 錯誤恢復）

**實際執行**：
- ✅ 調用了 `architect` 進行初步設計
- ❌ 沒有調用 `business-analyst` 分析監控需求
- ❌ 沒有調用 `data-specialist` 設計錯誤恢復演算法
- ❌ 沒有調用 `test-engineer` 規劃測試策略
- ❌ 直接進入實作階段

**複雜度評估（事後檢查）**：
- ✅ 新建檔案超過 50 行程式碼（3 個超過 200 行的檔案）
- ✅ 包含超過 3 個類別或函數（每個檔案都有多個類別）
- ✅ 涉及多個模組間的協調（監控、編排、錯誤恢復）
- ✅ 包含錯誤處理或重試邏輯（整個錯誤恢復服務）
- ✅ 需要理解用戶需求或工作流程（監控儀表板）
- ✅ 涉及演算法設計或優化（斷路器模式、重試策略）
- ✅ 需要性能分析或監控（監控指標設計）
- ✅ 包含並發或異步處理（工作流程協調）

**結論**：這是一個高複雜度任務，應該進行完整的多階段委派！

**正確的委派流程應該是**：
```
business-analyst（監控需求分析）
    ↓
architect（系統架構設計）
    ↓  
data-specialist（錯誤恢復演算法 + 監控指標）
    ↓
tech-lead（技術決策審查）
    ↓
test-engineer（測試策略）
    ↓
[基於所有專業建議進行實作]
```

#### 案例 2：正確委派範例

**任務**：實作用戶認證 API

**正確執行流程**：
1. **複雜度評估**：涉及安全、資料庫、API 設計 → 高複雜度
2. **business-analyst**：分析用戶登入流程和安全需求
3. **architect**：設計認證系統架構
4. **integration-specialist**：設計 API 介面和外部認證整合
5. **data-specialist**：設計 token 演算法和安全策略
6. **test-engineer**：設計安全測試策略
7. **tech-lead**：技術審查和最佳實踐確認
8. **實作階段**：基於所有專業建議進行開發

### 📋 委派決策檢查清單

#### 🔍 任務複雜度評估（優先執行）

**程式碼複雜度指標**：
- [ ] 新建檔案超過 50 行程式碼？
- [ ] 包含超過 3 個類別或函數？
- [ ] 涉及多個模組間的協調？
- [ ] 需要設計新的資料結構？
- [ ] 包含錯誤處理或重試邏輯？

**業務複雜度指標**：
- [ ] 需要理解用戶需求或工作流程？
- [ ] 涉及多個業務規則的協調？
- [ ] 影響用戶體驗或介面設計？
- [ ] 需要生成測試場景？

**技術複雜度指標**：
- [ ] 涉及演算法設計或優化？
- [ ] 需要性能分析或監控？
- [ ] 包含並發或異步處理？
- [ ] 涉及外部系統整合？
- [ ] 需要資料庫設計變更？

#### ⚡ 快速決策規則

**如果以上任何一個複雜度指標為「是」**：
1. 🛑 **立即停止自己實作**
2. 📋 **執行詳細檢查清單**
3. 🎯 **委派給相應的 Sub Agent**

#### 📝 詳細檢查清單

在開始任何任務前，**逐項檢查**：

**强制委派檢查**：
1. 這個任務是否涉及上述強制委派類別？
2. 這個任務的程式碼複雜度是否超過閾值？
3. 這個任務是否需要專業領域知識？
4. 這個任務是否會影響系統核心功能？
5. 我是否完全理解所有需求和影響？

**多階段委派判斷**：
6. 是否需要需求分析？ → `business-analyst` 先行
7. 是否需要架構設計？ → `architect` 參與  
8. 是否包含演算法邏輯？ → `data-specialist` 設計
9. 是否需要測試策略？ → `test-engineer` 規劃
10. 是否需要技術審查？ → `tech-lead` 確認

**決策結果**：
- ✅ **8-10 個「否」**：可以自己實作簡單功能
- ⚠️ **5-7 個「是」**：必須委派主要部分，可保留簡單整合
- 🛑 **1-4 個「是」**：完全委派，等待專業分析結果

#### 🔄 多階段委派流程

**階段 1：需求與設計**
```
business-analyst → architect → data-specialist
    ↓              ↓              ↓
  需求分析      架構設計      演算法設計
```

**階段 2：實作與品質**
```
[基於前階段成果] → tech-lead → test-engineer
                    ↓              ↓
                技術審查        測試策略
```

**階段 3：整合與文檔**
```
[實作完成] → integration-specialist → context-manager
              ↓                        ↓
            系統整合                  文檔更新
```

### 🎯 委派優先級矩陣

| 任務類型 | 優先委派順序 | 說明 |
|---------|-------------|------|
| **新功能開發** | business-analyst → architect → data-specialist → tech-lead | 完整流程 |
| **架構變更** | architect → tech-lead → test-engineer | 架構優先 |
| **演算法優化** | data-specialist → test-engineer → tech-lead | 效能優先 |
| **API 設計** | business-analyst → integration-specialist → tech-lead | 介面優先 |
| **錯誤處理** | data-specialist → test-engineer → tech-lead | 可靠性優先 |
| **監控儀表板** | business-analyst → data-specialist → tech-lead | 需求+指標 |

### 🔒 強制執行機制

#### 📝 委派執行確認清單

**在開始任何實作前，必須完成以下確認**：

```markdown
## 任務委派執行確認

### 任務基本信息
- [ ] 任務名稱：_________________
- [ ] 預估複雜度：簡單/中等/複雜
- [ ] 預估程式碼行數：_________

### 複雜度評估結果
- [ ] 程式碼複雜度指標檢查完成
- [ ] 業務複雜度指標檢查完成  
- [ ] 技術複雜度指標檢查完成
- [ ] 複雜度評估結論：_________

### 委派執行記錄
- [ ] business-analyst 委派：是/否/不需要
- [ ] architect 委派：是/否/不需要
- [ ] data-specialist 委派：是/否/不需要
- [ ] integration-specialist 委派：是/否/不需要
- [ ] test-engineer 委派：是/否/不需要
- [ ] tech-lead 委派：是/否/不需要
- [ ] context-manager 委派：是/否/不需要

### 委派結果摘要
- [ ] 已收到所有必要的專業建議
- [ ] 所有建議已整合到實作計劃中
- [ ] 實作方案符合 MVP 原則
- [ ] 準備開始實作

### 責任聲明
- [ ] 我確認已按照委派規則執行
- [ ] 我了解直接實作的風險和責任
```

#### ⚠️ 違規行為警告

**如果發現以下行為，必須立即停止並重新評估**：

1. 🚫 **跳過複雜度評估**直接開始實作
2. 🚫 **忽略強制委派規則**擅自判斷「不複雜」
3. 🚫 **只委派一個 agent**就開始複雜任務
4. 🚫 **不等待 agent 回應**就開始實作
5. 🚫 **忽略 agent 建議**按自己想法實作

#### 🎯 品質保證檢查點

**實作過程中的檢查點**：

**25% 進度檢查**：
- [ ] 實作方向是否符合 agent 建議？
- [ ] 是否遇到 agent 預警的問題？
- [ ] 是否需要額外的專業諮詢？

**50% 進度檢查**：
- [ ] 程式碼品質是否符合標準？
- [ ] 是否出現過度設計的跡象？
- [ ] 錯誤處理是否充分？

**75% 進度檢查**：
- [ ] 功能是否滿足原始需求？
- [ ] 測試覆蓋率是否足夠？
- [ ] 文檔是否需要更新？

**100% 完成檢查**：
- [ ] 執行自我反思機制
- [ ] 記錄學習經驗
- [ ] 更新最佳實踐

### 🚀 持續改進機制

#### 📊 委派效果追蹤

**每月統計和分析**：
- 委派 vs 直接實作的成功率比較
- 不同 agent 組合的效果評估
- 常見委派錯誤和改進建議
- 用戶滿意度和程式碼品質指標

#### 🔄 規則迭代優化

**規則更新觸發條件**：
- 發現新的委派錯誤模式
- Agent 能力範圍調整
- 技術棧或工具變更
- 團隊反饋和建議

#### 📚 知識庫建設

**持續補充案例庫**：
- 成功委派案例分析
- 失敗案例學習總結
- 最佳實踐模式提煉
- Agent 協作經驗分享

### 🎉 協作小隊成熟度評估

#### 🌟 成熟度等級

**Level 1 - 初學者**：
- 能夠識別基本委派規則
- 偶爾忘記複雜度評估
- 需要頻繁查閱指導文檔

**Level 2 - 熟練者**：
- 自動執行複雜度評估
- 正確委派大部分任務
- 開始理解多階段協作

**Level 3 - 專家**：
- 直覺判斷委派需求
- 靈活運用多 agent 協作
- 能夠優化委派策略

**Level 4 - 大師**：
- 預判潛在問題和風險
- 創新協作模式和方法
- 指導他人改進協作

#### 🎯 提升路徑

**從 Level 1 到 Level 2**：
- 嚴格執行檢查清單
- 學習案例分析
- 培養複雜度直覺

**從 Level 2 到 Level 3**：
- 實驗不同委派組合
- 分析 agent 建議品質
- 優化協作流程

**從 Level 3 到 Level 4**：
- 創新協作模式
- 分享最佳實踐
- 持續改進規則

## 開發方法論整合

### 規格驅動開發 (SDD) - 主框架
- **目標**: 結構化的開發流程管理  
- **階段**: requirements → design → tasks → implementation
- **觸發**: 使用 `/spec-init [功能名稱]` 開始

### 行為驅動開發 (BDD) - 需求工具
- **目標**: 描述業務行為和使用者需求
- **應用**: requirements階段生成Gherkin場景
- **檔案**: `.kiro/specs/[feature]/requirements.md`

### 領域驅動設計 (DDD) - 設計工具  
- **目標**: 建立清晰的領域模型
- **應用**: design階段建立實體和聚合
- **檔案**: `.kiro/specs/[feature]/design.md`

### 測試驅動開發 (TDD) - 品質工具
- **目標**: 確保核心邏輯的正確性
- **應用**: implementation階段，特別是複雜算法
- **觸發**: test-engineer 自動介入

## Sub Agents 調用指導

### 🔴 重要：調用 Sub Agent 時的必要提醒

在調用任何 Sub Agent 執行任務時，**必須**在 prompt 中包含以下指示：

```
【重要】開始任務前，請先閱讀並理解 .claude/agents/_core_principles.md 文件中的核心開發原則。

【具體任務】
[任務描述]

【預期產出】
請基於核心開發原則（MVP優先、漸進式開發、批判性思考、實用主義），提供最簡單可行的解決方案。
如果需求過於複雜，請先提出簡化建議。
```

如果 Sub Agent 無法訪問文件，則使用以下備用 prompt：

```
【核心開發原則摘要】
1. MVP 優先 - 從最簡單的解決方案開始
2. 漸進式開發 - 快速迭代，每次只加一個小功能  
3. 批判性思考 - 質疑需求，提供更好的替代方案
4. 實用主義 - YAGNI原則，避免過度設計

【具體任務】
[任務描述]
```

這確保所有 Sub Agents 都遵循相同的開發理念。

## Sub Agents 自動觸發規則

### general-assistant (通用助手)
**觸發詞**: 一般問題、簡單任務、不確定、哪個agent、幫助、解釋
**專業領域**: 
- 一般問答
- 簡單任務處理
- 跨領域協調
- 初步需求分類

### business-analyst (業務分析師)
**觸發詞**: 需求、分析、業務邏輯、BDD、場景、用戶故事、功能
**專業領域**: 
- 業務需求分析
- BDD場景生成
- 用戶體驗設計
- 功能規劃

### architect (系統架構師)
**觸發詞**: 架構、設計、系統、模組、組件、DDD、模式、框架
**專業領域**:
- 系統架構設計
- DDD領域建模
- 技術選型
- 模式設計

### data-specialist (數據專家)
**觸發詞**: 數據、算法、計算、處理、演算法、優化、效能
**專業領域**:
- 數據結構設計
- 算法實現
- 性能優化
- 計算邏輯

### integration-specialist (集成專家)
**觸發詞**: API、接口、集成、外部、服務、網路、通訊
**專業領域**:
- API設計與集成
- 外部服務整合
- 網路通訊
- 系統間集成

### test-engineer (測試工程師)
**觸發詞**: 測試、單元測試、整合測試、品質、覆蓋率、重構
**專業領域**:
- 測試策略設計
- 自動化測試
- 代碼品質檢查
- 重構支援

### tech-lead (技術主管)
**觸發詞**: 技術決策、代碼審查、團隊、技術債、重構、標準、最佳實踐
**專業領域**:
- 技術領導與決策
- 代碼品質管理
- 團隊協調
- 技術債管理

### context-manager (上下文管理專家)
**觸發詞**: 文檔、知識、上下文、記錄、歷史、決策、更新、維護
**專業領域**:
- 知識管理
- 文檔維護
- 信息同步
- 項目記憶

## 觸發詞自動查閱機制

當對話中出現以下關鍵詞時，自動查閱對應的快速參考文檔：

### 技術相關
- `API設計`、`RESTful` → 查閱 `docs/quick_reference/api_design.md`
- `數據結構`、`algorithm` → 查閱 `docs/quick_reference/data_structures.md`
- `設計模式`、`pattern` → 查閱 `docs/quick_reference/design_patterns.md`
- `性能優化`、`performance` → 查閱 `docs/quick_reference/performance.md`

### 開發流程
- `BDD場景`、`Gherkin` → 查閱 `docs/examples/bdd_scenarios.md`
- `多實例協作` → 查閱 `docs/collaboration/multi_instance.md`
- `角色分配` → 查閱 `docs/collaboration/role_assignment.md`
- `工作流程` → 查閱 `docs/collaboration/workflow.md`

### 錯誤處理
- `錯誤處理`、`error` → 查閱 `docs/quick_reference/error_handling.md`
- `檢查清單` → 查閱 `docs/checklists/`
- `故障排除` → 查閱 `docs/troubleshooting/`

## 自動化檢查規則

### 代碼品質檢查
每次代碼修改後，自動執行：
1. Python: Black格式化 + flake8檢查
2. JavaScript/TypeScript: Prettier格式化 + ESLint檢查
3. 單元測試執行（如果存在）
4. 類型檢查（如果適用）

### 安全檢查
每次完成開發後，自動檢查：
1. 是否有硬編碼的敏感信息
2. 錯誤處理是否完善
3. 輸入驗證是否充分
4. 安全最佳實踐遵循

### API調用審計
記錄所有API調用：
1. 時間戳記
2. 調用端點
3. 參數內容（敏感信息遮蔽）
4. 響應時間
5. 狀態碼

## 專案知識庫結構

### .kiro/steering/ - 核心知識
- `product.md`: 產品概述和目標
- `tech.md`: 技術棧和架構決策
- `structure.md`: 專案結構說明
- `methodology.md`: 開發方法論詳細說明
- `business_rules.md`: 業務規則和約束
- `collaboration.md`: 多實例協作規範

### .kiro/specs/ - 功能規格
每個功能都有獨立目錄：
```
feature-name/
├── spec.json          # 規格狀態和基本信息
├── requirements.md     # BDD需求文檔
├── design.md          # DDD設計文檔
└── tasks.md           # 具體任務清單
```

## 多實例協作工作流

### 角色分配範例
1. **產品實例**: 負責需求分析和產品設計
2. **架構實例**: 專注系統架構和技術設計
3. **開發實例**: 負責核心功能實現
4. **測試實例**: 負責測試設計和品質保證
5. **集成實例**: 負責系統集成和部署

### 分支策略
- `main`: 穩定版本
- `feature/[feature-name]`: 功能開發分支
- `role/[role-name]`: 角色專用分支
- `integration`: 整合測試分支

### 並行開發
- **Git Worktree**: 用於完全獨立的任務並行開發
- **多實例協作**: 用於需要協調的角色分工
- 詳見 `docs/guides/parallel-workflow.md`

### 同步機制
1. 每日同步會議（虛擬）
2. 重要節點的進度檢查
3. Git分支定期合併
4. 衝突解決和協調

## 品質保證標準

### 代碼標準
1. 所有函數必須有docstring
2. 核心邏輯必須有單元測試
3. API調用必須有錯誤處理
4. 敏感信息不得硬編碼

### 業務邏輯標準
1. 複雜算法必須有詳細註解
2. 關鍵決策必須有文檔說明
3. 用戶輸入必須有驗證
4. 異常情況必須有處理機制

### 文檔標準
1. 每個功能必須有BDD場景描述
2. 重要設計決策必須文檔化
3. API變更必須更新文檔
4. 例外情況必須說明處理方式

## 性能與監控

### 監控指標
1. Sub Agent響應時間
2. API調用頻率和響應時間
3. 測試執行時間
4. 內存和CPU使用率

### 日誌管理
1. 結構化日誌格式
2. 自動日誌輪轉
3. 敏感信息自動遮蔽
4. 錯誤日誌即時警報

### 性能優化
1. Sub Agent並行執行
2. API調用批次處理
3. 緩存常用計算結果
4. 定期清理臨時文件

## 任務記錄要求

### 強制任務文檔記錄

Claude 必須在完成以下任何任務後更新任務日誌：
- **程式碼變更**：創建、修改或刪除程式碼檔案
- **功能實作**：完成功能或子功能
- **Bug 修復**：解決任何錯誤或問題
- **架構決策**：進行設計或架構變更
- **文檔更新**：創建或更新重要文檔
- **配置變更**：修改專案配置檔案

### 任務日誌更新流程

1. **完成任務後**，執行：
   ```bash
   python .claude/scripts/update_task_log.py
   ```
   或使用快速記錄：
   ```bash
   python .claude/scripts/update_task_log.py "任務描述" "file1.py,file2.md" "摘要點1;摘要點2" "任務類型"
   ```

2. **必要資訊**：
   - 任務描述（簡潔，5-10 個字）
   - 任務類型：功能開發/Bug修復/重構/文檔更新/測試/其他
   - 影響檔案（修改或創建的主要檔案）
   - 摘要要點（3-5 個關鍵變更）
   - 相關標籤（可選，如 #功能名稱）

3. **自動歸檔**：日誌每週日自動歸檔到 `.kiro/logs/archive/`

### 任務日誌記錄範例

```markdown
### 2024-01-20 15:45
**任務**: 實作使用者認證系統
**類型**: 功能開發
**影響檔案**: 
- `src/auth/login.py`
- `src/auth/middleware.py`
- `tests/test_auth.py`
**變更摘要**: 
- 添加基於 JWT 的認證
- 創建登入/登出端點
- 實作認證中介軟體
- 添加完整測試
**相關議題**: #auth #security
```

### 不需記錄的情況
- 簡單的檔案讀取或搜尋
- 小型錯字修正（除非在關鍵程式碼中）
- 臨時除錯變更
- 不涉及變更的探索性分析